from colorama import Fore, Style
import requests
from requests.exceptions import TooManyRedirects
import re
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def call_PDFTron_exploits(environment,app_module_name,header,component_name):
    print(f"| {Fore.WHITE}[|||] {Style.DIM}{Style.BRIGHT}[{component_name}] Checking XSS vulnerability in current version...{Style.RESET_ALL}")
    check_version_js(environment,header,component_name)

def check_version_js(environment,header,component_name):
    # Sending a GET request to the URL without following redirects
    url = environment+'/PDFTron/scripts/PDFTron.webviewer_min.js'
    try:
        response = requests.get(
            url,
            headers=header,
            verify=False,
            allow_redirects=False,
        )
    except TooManyRedirects:
        print(
            f"| {Fore.WHITE}[|||] {Style.DIM}[{component_name}] Request aborted due to too many redirects.{Style.RESET_ALL}"
        )
        return

    # Checking the response code
    if response.status_code == 200:
        # Split the string by lines
        lines = response.text.splitlines()
        
        # Suponha que a codificação seja UTF-8 (ajuste se necessário)
        decoded_text = response.content.decode('utf-8')
        # Use regular expression para encontrar a versão
        match = re.search(r'\d+\.\d+\.\d+', decoded_text)

        if match.group(0) == '11.1.0':
            print(f"| {Fore.WHITE}[|||] {Style.RESET_ALL}{Fore.GREEN}[{component_name}] PDFTron version (apryse) is vulnerable to XSS execution through PDF file viewing!{Style.RESET_ALL}")
            print(f"| {Fore.WHITE}[|||] {Style.RESET_ALL}{Style.BRIGHT}[{component_name}] Use a PDF with embedded javascript or use the sample PDF at the url below:{Style.RESET_ALL}")
            print(f"| {Fore.WHITE}[POC] {Style.RESET_ALL}{Style.BRIGHT}[{component_name}] https://hacker.soarescorp.com/tools/payloads/xss/injected_alert_SampleReport.pdf{Style.RESET_ALL}")
        else:
            print(f"| {Fore.WHITE}[|||] {Style.DIM}[{component_name}] This version is not vulnerable to XSS via PDF viewing.{Style.RESET_ALL}")
    else:
        # The request failed or was redirected
        if response.status_code in (301, 302, 303, 307, 308):
            redirect_to = response.headers.get("Location", "unknown")
            print(
                f"| {Fore.WHITE}[|||] Request redirected to: {Style.DIM}[{redirect_to}]{Style.RESET_ALL}"
            )
            print(
                f"| {Fore.WHITE}[|||] {Style.DIM}[{component_name}] The PDFTron script redirected instead of returning data.{Style.RESET_ALL}"
            )
        else:
            print(
                f"| {Fore.WHITE}[|||] {Style.DIM}[{component_name}] This version is not vulnerable to XSS via PDF viewing.{Style.RESET_ALL}"
            )
